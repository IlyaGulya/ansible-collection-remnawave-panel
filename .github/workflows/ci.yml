name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    name: Validate Generator
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Lint generator code
        run: uv run ruff check src/

      - name: Type check generator code
        run: uv run mypy src/

      - name: Check freshness
        run: bash scripts/check-freshness.sh

  test-e2e:
    name: Run E2E Tests (Real Panel)
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies (with dev)
        run: uv sync --all-extras

      - name: Run E2E setup
        run: bash scripts/e2e-setup.sh

      - name: Run Molecule E2E tests
        run: |
          export E2E_API_TOKEN=$(cat molecule/e2e/.api-token)
          uv run molecule test -s e2e
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}

      - name: Collect container logs on failure
        if: failure()
        run: |
          cd molecule/e2e
          docker compose logs > docker-logs.txt 2>&1 || true
          echo "=== Docker Compose Logs ==="
          cat docker-logs.txt || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docker-logs
          path: molecule/e2e/docker-logs.txt
          retention-days: 7

      - name: Run E2E teardown
        if: always()
        run: bash scripts/e2e-teardown.sh

  lint-collection:
    name: Lint Ansible Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ansible-lint
        working-directory: ansible_collections/remnawave/panel
        run: uv run ansible-lint
        continue-on-error: true

  sanity:
    name: Ansible Sanity Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Run sanity tests
        working-directory: ansible_collections/remnawave/panel
        run: uv run ansible-test sanity --docker default

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Run unit tests
        working-directory: ansible_collections/remnawave/panel
        run: uv run ansible-test units --docker default -v
