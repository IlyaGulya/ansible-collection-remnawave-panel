name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    name: Validate Generator
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Lint generator code
        run: uv run ruff check src/

      - name: Type check generator code
        run: uv run mypy src/

      - name: Check freshness
        run: bash scripts/check-freshness.sh

  test-mock:
    name: Run Molecule Tests (Prism Mock)
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies (with dev)
        run: uv sync --all-extras

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Prism mock server
        run: npm install -g @stoplight/prism-cli

      - name: Start Prism mock server
        run: |
          prism mock api-spec/api-1.yaml -p 4010 &
          sleep 5

      - name: Install Ansible collection
        run: |
          mkdir -p ~/.ansible/collections/ansible_collections/remnawave
          ln -s ${{ github.workspace }}/collection ~/.ansible/collections/ansible_collections/remnawave/panel

      - name: Run Molecule tests
        run: uv run molecule test
        env:
          ANSIBLE_COLLECTIONS_PATH: ~/.ansible/collections

  test-e2e:
    name: Run E2E Tests (Real Panel)
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies (with dev)
        run: uv sync --all-extras

      - name: Install Ansible collection
        run: |
          mkdir -p ~/.ansible/collections/ansible_collections/remnawave
          ln -s ${{ github.workspace }}/collection ~/.ansible/collections/ansible_collections/remnawave/panel

      - name: Run E2E setup
        run: bash scripts/e2e-setup.sh

      - name: Run Molecule E2E tests
        run: |
          export E2E_API_TOKEN=$(cat molecule/e2e/.api-token)
          uv run molecule test -s e2e
        env:
          ANSIBLE_COLLECTIONS_PATH: ~/.ansible/collections

      - name: Collect container logs on failure
        if: failure()
        run: |
          cd molecule/e2e
          docker compose logs > docker-logs.txt 2>&1 || true
          echo "=== Docker Compose Logs ==="
          cat docker-logs.txt || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docker-logs
          path: molecule/e2e/docker-logs.txt
          retention-days: 7

      - name: Run E2E teardown
        if: always()
        run: bash scripts/e2e-teardown.sh

  lint-collection:
    name: Lint Ansible Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ansible-lint
        run: |
          uv pip install ansible-lint
          cd collection && uv run ansible-lint
        continue-on-error: true

  sanity:
    name: Ansible Sanity Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-core
        run: pip install ansible-core

      - name: Set up collection path
        run: |
          mkdir -p ~/.ansible/collections/ansible_collections/remnawave
          ln -s ${{ github.workspace }}/collection ~/.ansible/collections/ansible_collections/remnawave/panel

      - name: Run sanity tests
        working-directory: ~/.ansible/collections/ansible_collections/remnawave/panel
        run: ansible-test sanity --docker default
