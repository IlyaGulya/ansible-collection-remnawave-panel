name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate-generator:
    name: Validate Generator
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Lint generator code
        run: uvx ruff check src/

      - name: Type check generator code
        run: uvx mypy src/

      - name: Check version sync
        run: uv run version check

      - name: Check freshness
        run: bash scripts/check-freshness.sh

  lint-collection:
    name: Lint Ansible Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ansible-lint
        working-directory: ansible_collections/remnawave/panel
        run: uv run ansible-lint
        continue-on-error: true

  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      sanity_matrix: ${{ steps.generate.outputs.sanity_matrix }}
      unit_matrix: ${{ steps.generate.outputs.unit_matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tox-ansible
        run: pip install tox-ansible

      - name: Generate test matrices
        id: generate
        working-directory: ansible_collections/remnawave/panel
        run: |
          # Generate sanity matrix
          SANITY_MATRIX=$(tox --ansible --gh-matrix --matrix-scope sanity --conf tox-ansible.ini 2>/dev/null || echo '{"include":[]}')
          echo "sanity_matrix=$SANITY_MATRIX" >> $GITHUB_OUTPUT

          # Generate unit matrix
          UNIT_MATRIX=$(tox --ansible --gh-matrix --matrix-scope unit --conf tox-ansible.ini 2>/dev/null || echo '{"include":[]}')
          echo "unit_matrix=$UNIT_MATRIX" >> $GITHUB_OUTPUT

  sanity:
    name: Sanity (${{ matrix.name }})
    needs: [validate-generator, generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.sanity_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tox-ansible
        run: pip install tox-ansible

      - name: Run sanity tests
        working-directory: ansible_collections/remnawave/panel
        run: tox --ansible -e ${{ matrix.name }} --conf tox-ansible.ini

  unit:
    name: Unit (${{ matrix.name }})
    needs: [validate-generator, generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.unit_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tox-ansible
        run: pip install tox-ansible

      - name: Run unit tests
        working-directory: ansible_collections/remnawave/panel
        run: tox --ansible -e ${{ matrix.name }} --conf tox-ansible.ini

  e2e:
    name: E2E Tests
    needs: validate-generator
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Install community.docker collection
        run: uv run ansible-galaxy collection install community.docker

      - name: Run E2E tests
        working-directory: ansible_collections/remnawave/panel
        run: uv run molecule test -s e2e

      - name: Collect container logs on failure
        if: failure()
        run: |
          cd ansible_collections/remnawave/panel/extensions/molecule/e2e
          docker compose logs > docker-logs.txt 2>&1 || true
          echo "=== Docker Compose Logs ==="
          cat docker-logs.txt || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docker-logs
          path: ansible_collections/remnawave/panel/extensions/molecule/e2e/docker-logs.txt
          retention-days: 7

      - name: Cleanup Docker containers
        if: always()
        run: |
          cd ansible_collections/remnawave/panel/extensions/molecule/e2e
          docker compose down -v --remove-orphans 2>/dev/null || true
