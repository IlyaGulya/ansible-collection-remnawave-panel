name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate-generator:
    name: Validate Generator
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          environments: dev

      - name: Lint generator code
        run: pixi run lint

      - name: Type check generator code
        run: pixi run typecheck

      - name: Check version sync
        run: pixi run version-check

      - name: Check freshness
        run: pixi run check-freshness

  lint-collection:
    name: Lint Ansible Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          environments: dev

      - name: Run ansible-lint
        run: pixi run ansible-lint
        continue-on-error: true

  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      # Wrap tox-ansible array output in {include: [...]} for GitHub Actions matrix
      sanity_matrix: '{"include": ${{ steps.sanity.outputs.envlist }}}'
      unit_matrix: '{"include": ${{ steps.unit.outputs.envlist }}}'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          environments: dev

      - name: Generate sanity matrix
        id: sanity
        run: pixi run tox-matrix-sanity

      - name: Generate unit matrix
        id: unit
        run: pixi run tox-matrix-unit

  sanity:
    name: Sanity (${{ matrix.name }})
    needs: [validate-generator, generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.sanity_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          environments: dev

      - name: Run sanity tests
        run: pixi run tox-sanity ${{ matrix.name }}

  unit:
    name: Unit (${{ matrix.name }})
    needs: [validate-generator, generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.unit_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          environments: dev

      - name: Run unit tests
        run: pixi run tox-unit ${{ matrix.name }}

  e2e:
    name: E2E Tests
    needs: validate-generator
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          environments: dev

      - name: Install community.docker collection
        run: pixi run ansible-galaxy collection install community.docker

      - name: Run E2E tests
        run: pixi run molecule-test

      - name: Collect container logs on failure
        if: failure()
        run: |
          cd ansible_collections/remnawave/panel/extensions/molecule/e2e
          docker compose logs > docker-logs.txt 2>&1 || true
          echo "=== Docker Compose Logs ==="
          cat docker-logs.txt || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docker-logs
          path: ansible_collections/remnawave/panel/extensions/molecule/e2e/docker-logs.txt
          retention-days: 7

      - name: Cleanup Docker containers
        if: always()
        run: |
          cd ansible_collections/remnawave/panel/extensions/molecule/e2e
          docker compose down -v --remove-orphans 2>/dev/null || true
