---
- name: Converge - E2E Tests
  hosts: localhost
  gather_facts: false
  vars:
    api_url: "http://localhost:8080"
    api_token: "{{ lookup('file', playbook_dir + '/.api-token') | trim }}"
    # Minimal valid Xray config - must have at least one inbound
    test_config:
      log:
        loglevel: info
      inbounds:
        - tag: TestInbound
          port: 10000
          protocol: shadowsocks
          settings:
            clients: []
            network: tcp,udp
          sniffing:
            enabled: true
            destOverride:
              - http
              - tls
      outbounds:
        - tag: DIRECT
          protocol: freedom
      routing:
        rules: []

    # Updated config for update tests
    test_config_updated:
      log:
        loglevel: warning
      inbounds:
        - tag: UpdatedInbound
          port: 10001
          protocol: shadowsocks
          settings:
            clients: []
            network: tcp,udp
          sniffing:
            enabled: true
            destOverride:
              - http
              - tls
      outbounds:
        - tag: DIRECT
          protocol: freedom
      routing:
        rules: []

  collections:
    - remnawave.panel

  tasks:
    # ===========================================
    # Section 1: Config Profile Create Tests
    # ===========================================

    - name: Create a config profile
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Profile"
        config: "{{ test_config }}"
      register: create_profile_result

    - name: Assert config profile was created
      ansible.builtin.assert:
        that:
          - create_profile_result.changed
          - create_profile_result.response is defined
          - create_profile_result.response.uuid is defined
        fail_msg: "Config profile creation failed"

    - name: Create same config profile again (idempotency test)
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Profile"
        config: "{{ test_config }}"
      register: idempotent_profile_result

    - name: Assert config profile is idempotent
      ansible.builtin.assert:
        that:
          - not idempotent_profile_result.changed
        fail_msg: "Config profile should be idempotent"

    # Extract inbound UUID for node tests
    - name: Set profile and inbound UUIDs
      ansible.builtin.set_fact:
        profile_uuid: "{{ create_profile_result.response.uuid }}"
        inbound_uuid: "{{ create_profile_result.response.inbounds[0].uuid }}"

    # ===========================================
    # Section 2: Config Profile Update Tests
    # ===========================================

    - name: Update config profile
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Profile"
        config: "{{ test_config_updated }}"
      register: update_profile_result

    - name: Assert config profile was updated
      ansible.builtin.assert:
        that:
          - update_profile_result.changed
          - update_profile_result.response.config.log.loglevel == 'warning'
        fail_msg: "Config profile update failed"

    - name: Update config profile again (idempotency test)
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Profile"
        config: "{{ test_config_updated }}"
      register: update_profile_idempotent_result

    - name: Assert config profile update is idempotent
      ansible.builtin.assert:
        that:
          - not update_profile_idempotent_result.changed
        fail_msg: "Config profile update should be idempotent"

    # Update inbound UUID after config change
    - name: Update inbound UUID after config change
      ansible.builtin.set_fact:
        inbound_uuid: "{{ update_profile_result.response.inbounds[0].uuid }}"

    # ===========================================
    # Section 3: Config Profile Check Mode Tests
    # ===========================================

    - name: Create config profile in check mode
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Check Mode Profile"
        config: "{{ test_config }}"
      check_mode: true
      register: check_mode_create_profile_result

    - name: Assert check mode reports changed for new profile
      ansible.builtin.assert:
        that:
          - check_mode_create_profile_result.changed
          - check_mode_create_profile_result.diff is defined
          - check_mode_create_profile_result.diff.before == {}
        fail_msg: "Check mode should report changed for new profile"

    - name: Verify check mode did not create profile
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "Check Mode Profile"
      register: verify_check_mode_no_create

    - name: Assert check mode profile was not created
      ansible.builtin.assert:
        that:
          - not verify_check_mode_no_create.changed
        fail_msg: "Check mode should not have created the profile"

    - name: Update existing profile in check mode
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Profile"
        config: "{{ test_config }}"
      check_mode: true
      register: check_mode_update_profile_result

    - name: Assert check mode reports changed for update
      ansible.builtin.assert:
        that:
          - check_mode_update_profile_result.changed
          - check_mode_update_profile_result.diff is defined
          - check_mode_update_profile_result.diff.before != {}
          - check_mode_update_profile_result.diff.after != {}
        fail_msg: "Check mode should report changed for profile update"

    - name: Delete existing profile in check mode
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "E2E Test Profile"
      check_mode: true
      register: check_mode_delete_profile_result

    - name: Assert check mode reports changed for delete
      ansible.builtin.assert:
        that:
          - check_mode_delete_profile_result.changed
          - check_mode_delete_profile_result.diff is defined
          - check_mode_delete_profile_result.diff.after == {}
        fail_msg: "Check mode should report changed for profile delete"

    - name: Verify profile still exists after check mode delete
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Profile"
        config: "{{ test_config_updated }}"
      register: verify_profile_still_exists

    - name: Assert profile still exists after check mode delete
      ansible.builtin.assert:
        that:
          - not verify_profile_still_exists.changed
        fail_msg: "Profile should still exist after check mode delete"

    # ===========================================
    # Section 4: Config Profile UUID Lookup Tests
    # ===========================================

    - name: Create UUID lookup profile
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "UUID Lookup Profile"
        config: "{{ test_config }}"
      register: uuid_lookup_profile_result

    - name: Assert UUID lookup profile was created
      ansible.builtin.assert:
        that:
          - uuid_lookup_profile_result.changed
          - uuid_lookup_profile_result.response.uuid is defined
        fail_msg: "UUID lookup profile creation failed"

    - name: Lookup config profile by UUID
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        uuid: "{{ uuid_lookup_profile_result.response.uuid }}"
        name: "UUID Lookup Profile"
        config: "{{ test_config }}"
      register: profile_uuid_lookup_result

    - name: Assert profile UUID lookup is idempotent
      ansible.builtin.assert:
        that:
          - not profile_uuid_lookup_result.changed
        fail_msg: "Profile UUID lookup should be idempotent"

    # ===========================================
    # Section 5: Node Create Tests
    # ===========================================

    - name: Create a node
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Node"
        address: "10.0.0.1"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: create_node_result

    - name: Assert node was created
      ansible.builtin.assert:
        that:
          - create_node_result.changed
          - create_node_result.response is defined
        fail_msg: "Node creation failed"

    - name: Create same node again (idempotency test)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Node"
        address: "10.0.0.1"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: idempotent_node_result

    - name: Assert node is idempotent
      ansible.builtin.assert:
        that:
          - not idempotent_node_result.changed
        fail_msg: "Node should be idempotent"

    # ===========================================
    # Section 6: Node Update Tests
    # ===========================================

    - name: Update node address
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Node"
        address: "10.0.0.2"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: update_node_result

    - name: Assert node was updated
      ansible.builtin.assert:
        that:
          - update_node_result.changed
        fail_msg: "Node update failed"

    - name: Update node address again (idempotency test)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Node"
        address: "10.0.0.2"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: update_node_idempotent_result

    - name: Assert node update is idempotent
      ansible.builtin.assert:
        that:
          - not update_node_idempotent_result.changed
        fail_msg: "Node update should be idempotent"

    # Store node UUID for later tests
    - name: Store node UUID
      ansible.builtin.set_fact:
        node_uuid: "{{ create_node_result.response.uuid }}"

    # ===========================================
    # Section 7: Node Optional Parameters Tests
    # ===========================================

    - name: Create node with all optional parameters
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Full Params Node"
        address: "10.0.0.50"
        port: 8443
        is_traffic_tracking_active: true
        traffic_limit_bytes: 10737418240
        notify_percent: 80
        traffic_reset_day: 15
        country_code: "US"
        consumption_multiplier: 1.5
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: full_params_node_result

    - name: Assert full params node was created
      ansible.builtin.assert:
        that:
          - full_params_node_result.changed
          - full_params_node_result.response is defined
          - full_params_node_result.response.port == 8443
          - full_params_node_result.response.is_traffic_tracking_active == true
          - full_params_node_result.response.traffic_limit_bytes == 10737418240
          - full_params_node_result.response.notify_percent == 80
          - full_params_node_result.response.traffic_reset_day == 15
          - full_params_node_result.response.country_code == "US"
          - full_params_node_result.response.consumption_multiplier == 1.5
        fail_msg: "Full params node creation failed or values mismatch"

    - name: Create full params node again (idempotency test)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Full Params Node"
        address: "10.0.0.50"
        port: 8443
        is_traffic_tracking_active: true
        traffic_limit_bytes: 10737418240
        notify_percent: 80
        traffic_reset_day: 15
        country_code: "US"
        consumption_multiplier: 1.5
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: full_params_idempotent_result

    - name: Assert full params node is idempotent
      ansible.builtin.assert:
        that:
          - not full_params_idempotent_result.changed
        fail_msg: "Full params node should be idempotent"

    - name: Update traffic settings
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Full Params Node"
        address: "10.0.0.50"
        port: 8443
        is_traffic_tracking_active: true
        traffic_limit_bytes: 21474836480
        notify_percent: 90
        traffic_reset_day: 15
        country_code: "US"
        consumption_multiplier: 1.5
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: update_traffic_result

    - name: Assert traffic settings were updated
      ansible.builtin.assert:
        that:
          - update_traffic_result.changed
          - update_traffic_result.response.traffic_limit_bytes == 21474836480
          - update_traffic_result.response.notify_percent == 90
        fail_msg: "Traffic settings update failed"

    # ===========================================
    # Section 8: Node Check Mode Tests
    # ===========================================

    - name: Update node in check mode
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Node"
        address: "10.0.0.99"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      check_mode: true
      register: check_mode_update_node_result

    - name: Assert check mode reports changed for node update
      ansible.builtin.assert:
        that:
          - check_mode_update_node_result.changed
          - check_mode_update_node_result.diff is defined
        fail_msg: "Check mode should report changed for node update"

    - name: Delete node in check mode
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "E2E Test Node"
      check_mode: true
      register: check_mode_delete_node_result

    - name: Assert check mode reports changed for node delete
      ansible.builtin.assert:
        that:
          - check_mode_delete_node_result.changed
          - check_mode_delete_node_result.diff is defined
          - check_mode_delete_node_result.diff.after == {}
        fail_msg: "Check mode should report changed for node delete"

    - name: Verify node still exists after check mode delete
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "E2E Test Node"
        address: "10.0.0.2"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: verify_node_still_exists

    - name: Assert node still exists after check mode delete
      ansible.builtin.assert:
        that:
          - not verify_node_still_exists.changed
        fail_msg: "Node should still exist after check mode delete"

    # ===========================================
    # Section 9: Node UUID Lookup Tests
    # ===========================================

    - name: Lookup node by UUID
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        uuid: "{{ node_uuid }}"
        name: "E2E Test Node"
        address: "10.0.0.2"
        port: 443
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: node_uuid_lookup_result

    - name: Assert node UUID lookup is idempotent
      ansible.builtin.assert:
        that:
          - not node_uuid_lookup_result.changed
        fail_msg: "Node UUID lookup should be idempotent"

    # ===========================================
    # Section 10: Error Handling Tests
    # ===========================================

    - name: Attempt to create node with name too short
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "AB"
        address: "10.0.0.200"
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      ignore_errors: true
      register: short_name_error_result

    - name: Assert short name error
      ansible.builtin.assert:
        that:
          - short_name_error_result.failed
        fail_msg: "Node creation with short name should fail"

    # ===========================================
    # Section 10.5: Config Profile Name Resolution Tests
    # ===========================================

    - name: Create node using config profile NAME (not UUID)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Name Lookup Test Node"
        address: "10.0.0.200"
        port: 443
        config_profile:
          active_config_profile: "E2E Test Profile"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: name_lookup_result

    - name: Assert node with profile name was created
      ansible.builtin.assert:
        that:
          - name_lookup_result.changed
          - name_lookup_result.response.uuid is defined
        fail_msg: "Node creation with profile name lookup failed"

    - name: Create same node again (idempotency with name lookup)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Name Lookup Test Node"
        address: "10.0.0.200"
        port: 443
        config_profile:
          active_config_profile: "E2E Test Profile"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: name_lookup_idempotent

    - name: Assert name lookup is idempotent
      ansible.builtin.assert:
        that:
          - not name_lookup_idempotent.changed
        fail_msg: "Node with profile name lookup should be idempotent"

    - name: Test error when config profile name not found
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Nonexistent Profile Node"
        address: "10.0.0.201"
        port: 443
        config_profile:
          active_config_profile: "Nonexistent Profile Name"
          active_inbounds: []
      ignore_errors: true
      register: not_found_result

    - name: Assert not found error
      ansible.builtin.assert:
        that:
          - not_found_result.failed
          - "'not found' in not_found_result.msg"
        fail_msg: "Should fail when config profile name is not found"

    - name: Cleanup name lookup test node
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "Name Lookup Test Node"

    # ===========================================
    # Section 10.6: Inbound Tag Resolution Tests
    # ===========================================

    - name: Create node using inbound TAG (not UUID)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Inbound Tag Test Node"
        address: "10.0.0.202"
        port: 443
        config_profile:
          active_config_profile: "E2E Test Profile"
          active_inbound_tags:
            - "UpdatedInbound"
      register: inbound_tag_result

    - name: Assert node with inbound tag was created
      ansible.builtin.assert:
        that:
          - inbound_tag_result.changed
          - inbound_tag_result.response.uuid is defined
        fail_msg: "Node creation with inbound tag lookup failed"

    - name: Create same node again (idempotency with inbound tag)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Inbound Tag Test Node"
        address: "10.0.0.202"
        port: 443
        config_profile:
          active_config_profile: "E2E Test Profile"
          active_inbound_tags:
            - "UpdatedInbound"
      register: inbound_tag_idempotent

    - name: Assert inbound tag lookup is idempotent
      ansible.builtin.assert:
        that:
          - not inbound_tag_idempotent.changed
        fail_msg: "Node with inbound tag lookup should be idempotent"

    - name: Test error when inbound tag not found
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: present
        name: "Nonexistent Inbound Node"
        address: "10.0.0.203"
        port: 443
        config_profile:
          active_config_profile: "E2E Test Profile"
          active_inbound_tags:
            - "NonexistentInbound"
      ignore_errors: true
      register: inbound_not_found_result

    - name: Assert inbound not found error
      ansible.builtin.assert:
        that:
          - inbound_not_found_result.failed
          - "'not found' in inbound_not_found_result.msg"
        fail_msg: "Should fail when inbound tag is not found"

    - name: Cleanup inbound tag test node
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "Inbound Tag Test Node"

    # ===========================================
    # Section 11: Cleanup - Delete Operations
    # ===========================================

    - name: Delete full params node
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "Full Params Node"
      register: delete_full_params_node_result

    - name: Assert full params node was deleted
      ansible.builtin.assert:
        that:
          - delete_full_params_node_result.changed
        fail_msg: "Full params node deletion should report changed"

    - name: Delete full params node again (idempotency test)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "Full Params Node"
      register: delete_full_params_node_idempotent_result

    - name: Assert full params node deletion is idempotent
      ansible.builtin.assert:
        that:
          - not delete_full_params_node_idempotent_result.changed
        fail_msg: "Full params node deletion should be idempotent"

    - name: Delete test node
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "E2E Test Node"
      register: delete_node_result

    - name: Assert node was deleted
      ansible.builtin.assert:
        that:
          - delete_node_result.changed
        fail_msg: "Node deletion should report changed"

    - name: Delete node again (idempotency test)
      remnawave.panel.node:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "E2E Test Node"
      register: delete_node_idempotent_result

    - name: Assert node deletion is idempotent
      ansible.builtin.assert:
        that:
          - not delete_node_idempotent_result.changed
        fail_msg: "Node deletion should be idempotent"

    - name: Delete UUID lookup profile
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "UUID Lookup Profile"
      register: delete_uuid_lookup_profile_result

    - name: Assert UUID lookup profile was deleted
      ansible.builtin.assert:
        that:
          - delete_uuid_lookup_profile_result.changed
        fail_msg: "UUID lookup profile deletion should report changed"

    - name: Delete UUID lookup profile again (idempotency test)
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "UUID Lookup Profile"
      register: delete_uuid_lookup_profile_idempotent_result

    - name: Assert UUID lookup profile deletion is idempotent
      ansible.builtin.assert:
        that:
          - not delete_uuid_lookup_profile_idempotent_result.changed
        fail_msg: "UUID lookup profile deletion should be idempotent"

    - name: Delete test config profile
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "E2E Test Profile"
      register: delete_profile_result

    - name: Assert config profile was deleted
      ansible.builtin.assert:
        that:
          - delete_profile_result.changed
        fail_msg: "Config profile deletion should report changed"

    - name: Delete config profile again (idempotency test)
      remnawave.panel.config_profile:
        api_url: "{{ api_url }}"
        api_token: "{{ api_token }}"
        state: absent
        name: "E2E Test Profile"
      register: delete_profile_idempotent_result

    - name: Assert config profile deletion is idempotent
      ansible.builtin.assert:
        that:
          - not delete_profile_idempotent_result.changed
        fail_msg: "Config profile deletion should be idempotent"
