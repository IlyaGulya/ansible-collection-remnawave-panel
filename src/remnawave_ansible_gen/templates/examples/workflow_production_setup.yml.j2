# AUTOMATICALLY GENERATED - DO NOT EDIT
# Generated by remnawave-ansible-gen
#
# Example: Production-like infrastructure setup workflow
# Creates multiple config profiles by region, then nodes assigned to each profile
# Demonstrates realistic multi-region VPN infrastructure deployment
# Usage: ansible-playbook production_setup.yml -e @../vars/production_vars.yml
---
- name: Production Infrastructure Setup
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/production_vars.yml

  tasks:
    # =========================================
    # Step 1: Create All Config Profiles
    # =========================================

    - name: Create config profiles for each region
      remnawave.panel.config_profile:
        api_url: "{{ '{{' }} remnawave_api_url {{ '}}' }}"
        api_token: "{{ '{{' }} remnawave_api_token {{ '}}' }}"
        state: present
        name: "{{ '{{' }} item.name {{ '}}' }}"
        config: "{{ '{{' }} item.config {{ '}}' }}"
      loop: "{{ '{{' }} config_profiles {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.name {{ '}}' }}"
      register: profiles_result

    - name: Display created profiles
      ansible.builtin.debug:
        msg: "Profile '{{ '{{' }} item.item.name {{ '}}' }}': {{ '{{' }} 'created' if item.changed else 'already exists' {{ '}}' }}"
      loop: "{{ '{{' }} profiles_result.results {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.item.name {{ '}}' }}"

    # =========================================
    # Step 2: Build Profile Lookup Dictionary
    # Maps profile names to their UUIDs and inbound UUIDs
    # =========================================

    - name: Build profile lookup dictionary
      ansible.builtin.set_fact:
        profile_lookup: >-
          {{ '{{' }} profile_lookup | default({}) | combine({
            item.item.name: {
              'uuid': item.response.uuid,
              'inbound_uuid': item.response.inbounds[0].uuid
            }
          }) {{ '}}' }}
      loop: "{{ '{{' }} profiles_result.results {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.item.name {{ '}}' }}"

    - name: Display profile lookup table
      ansible.builtin.debug:
        msg: "Profile '{{ '{{' }} item.key {{ '}}' }}' -> UUID: {{ '{{' }} item.value.uuid {{ '}}' }}, Inbound: {{ '{{' }} item.value.inbound_uuid {{ '}}' }}"
      loop: "{{ '{{' }} profile_lookup | dict2items {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.key {{ '}}' }}"

    # =========================================
    # Step 3: Create All Nodes
    # Each node references its assigned profile by name
    # =========================================

    - name: Create nodes with regional profile assignment
      remnawave.panel.node:
        api_url: "{{ '{{' }} remnawave_api_url {{ '}}' }}"
        api_token: "{{ '{{' }} remnawave_api_token {{ '}}' }}"
        state: present
        name: "{{ '{{' }} item.name {{ '}}' }}"
        address: "{{ '{{' }} item.address {{ '}}' }}"
        port: "{{ '{{' }} item.port {{ '}}' }}"
        country_code: "{{ '{{' }} item.country_code | default(omit) {{ '}}' }}"
        is_traffic_tracking_active: "{{ '{{' }} traffic_settings.is_tracking_active | default(false) {{ '}}' }}"
        traffic_limit_bytes: "{{ '{{' }} (item.traffic_limit_gb | default(0)) * 1073741824 | int if item.traffic_limit_gb is defined else omit {{ '}}' }}"
        notify_percent: "{{ '{{' }} traffic_settings.notify_percent | default(omit) {{ '}}' }}"
        traffic_reset_day: "{{ '{{' }} traffic_settings.reset_day | default(omit) {{ '}}' }}"
        consumption_multiplier: "{{ '{{' }} traffic_settings.consumption_multiplier | default(omit) {{ '}}' }}"
        config_profile:
          active_config_profile_uuid: "{{ '{{' }} profile_lookup[item.profile].uuid {{ '}}' }}"
          active_inbounds:
            - "{{ '{{' }} profile_lookup[item.profile].inbound_uuid {{ '}}' }}"
      loop: "{{ '{{' }} nodes {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.name {{ '}}' }} ({{ '{{' }} item.profile {{ '}}' }})"
      register: nodes_result

    # =========================================
    # Summary
    # =========================================

    - name: Group nodes by profile for summary
      ansible.builtin.set_fact:
        nodes_by_profile: "{{ '{{' }} nodes_by_profile | default({}) | combine({item.profile: (nodes_by_profile[item.profile] | default([])) + [item.name]}) {{ '}}' }}"
      loop: "{{ '{{' }} nodes {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.name {{ '}}' }}"

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Production Infrastructure Deployment Complete"
          - "============================================"
          - ""
          - "Config Profiles: {{ '{{' }} config_profiles | length {{ '}}' }}"
          - "Total Nodes: {{ '{{' }} nodes | length {{ '}}' }}"
          - ""
          - "Regions:"
          - "  - US: {{ '{{' }} nodes | selectattr('country_code', 'in', ['US']) | list | length {{ '}}' }} nodes"
          - "  - EU: {{ '{{' }} nodes | selectattr('country_code', 'in', ['DE', 'NL', 'FR', 'GB']) | list | length {{ '}}' }} nodes"
          - "  - Asia: {{ '{{' }} nodes | selectattr('country_code', 'in', ['SG', 'JP', 'KR', 'HK']) | list | length {{ '}}' }} nodes"

    - name: Display nodes grouped by profile
      ansible.builtin.debug:
        msg: "{{ '{{' }} item.key {{ '}}' }}: {{ '{{' }} item.value | join(', ') {{ '}}' }}"
      loop: "{{ '{{' }} nodes_by_profile | dict2items {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.key {{ '}}' }}"

    - name: Display node status
      ansible.builtin.debug:
        msg: "{{ '{{' }} item.item.name {{ '}}' }} ({{ '{{' }} item.item.country_code {{ '}}' }}): {{ '{{' }} 'created' if item.changed else 'already exists' {{ '}}' }}"
      loop: "{{ '{{' }} nodes_result.results {{ '}}' }}"
      loop_control:
        label: "{{ '{{' }} item.item.name {{ '}}' }}"
