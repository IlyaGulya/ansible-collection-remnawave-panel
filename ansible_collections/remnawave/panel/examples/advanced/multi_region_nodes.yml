# AUTOMATICALLY GENERATED - DO NOT EDIT
# Generated by remnawave-ansible-gen
#
# Example: Multi-region node deployment using loops
# Demonstrates deploying multiple nodes from a list
# Usage: ansible-playbook multi_region_nodes.yml -e @../vars/example_vars.yml
---
- name: Multi-Region Node Deployment
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/example_vars.yml

  tasks:
    # =========================================
    # Step 1: Ensure Config Profile Exists
    # =========================================

    - name: Create config profile for multi-region deployment
      remnawave.panel.config_profile:
        api_url: "{{ remnawave_api_url }}"
        api_token: "{{ remnawave_api_token }}"
        state: present
        name: "{{ config_profile_name }}"
        config: "{{ xray_config }}"
      register: profile_result

    - name: Set profile facts
      ansible.builtin.set_fact:
        profile_uuid: "{{ profile_result.response.uuid }}"
        inbound_uuid: "{{ profile_result.response.inbounds[0].uuid }}"

    # =========================================
    # Step 2: Deploy Nodes Using Loop
    # =========================================

    - name: Create nodes in multiple regions
      remnawave.panel.node:
        api_url: "{{ remnawave_api_url }}"
        api_token: "{{ remnawave_api_token }}"
        state: present
        name: "{{ item.name }}"
        address: "{{ item.address }}"
        port: "{{ item.port }}"
        country_code: "{{ item.country_code | default(omit) }}"
        is_traffic_tracking_active: "{{ traffic_tracking.is_active | default(false) }}"
        traffic_limit_bytes: "{{ traffic_tracking.limit_bytes | default(omit) }}"
        notify_percent: "{{ traffic_tracking.notify_percent | default(omit) }}"
        traffic_reset_day: "{{ traffic_tracking.reset_day | default(omit) }}"
        consumption_multiplier: "{{ traffic_tracking.consumption_multiplier | default(omit) }}"
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      loop: "{{ nodes }}"
      register: nodes_result

    # =========================================
    # Summary
    # =========================================

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "Multi-region deployment complete!"
          - "Profile: {{ config_profile_name }}"
          - "Nodes deployed: {{ nodes | length }}"
          - "Regions: {{ nodes | map(attribute='country_code') | list | join(', ') }}"

    - name: List deployed nodes
      ansible.builtin.debug:
        msg: "{{ item.item.name }} ({{ item.item.country_code }}): {{ 'created' if item.changed else 'already exists' }}"
      loop: "{{ nodes_result.results }}"
      loop_control:
        label: "{{ item.item.name }}"
