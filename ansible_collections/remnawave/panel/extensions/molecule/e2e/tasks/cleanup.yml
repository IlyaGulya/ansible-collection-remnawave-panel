---
# ===========================================
# Section 11: Cleanup - Delete Operations
# ===========================================

- name: Delete full params node
  remnawave.panel.node:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "Full Params Node"
  register: delete_full_params_node_result

- name: Assert full params node was deleted
  ansible.builtin.assert:
    that:
      - delete_full_params_node_result.changed
    fail_msg: "Full params node deletion should report changed"

- name: Delete full params node again (idempotency test)
  remnawave.panel.node:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "Full Params Node"
  register: delete_full_params_node_idempotent_result

- name: Assert full params node deletion is idempotent
  ansible.builtin.assert:
    that:
      - not delete_full_params_node_idempotent_result.changed
    fail_msg: "Full params node deletion should be idempotent"

- name: Delete test node
  remnawave.panel.node:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "E2E Test Node"
  register: delete_node_result

- name: Assert node was deleted
  ansible.builtin.assert:
    that:
      - delete_node_result.changed
    fail_msg: "Node deletion should report changed"

- name: Delete node again (idempotency test)
  remnawave.panel.node:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "E2E Test Node"
  register: delete_node_idempotent_result

- name: Assert node deletion is idempotent
  ansible.builtin.assert:
    that:
      - not delete_node_idempotent_result.changed
    fail_msg: "Node deletion should be idempotent"

- name: Delete UUID lookup profile
  remnawave.panel.config_profile:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "UUID Lookup Profile"
  register: delete_uuid_lookup_profile_result

- name: Assert UUID lookup profile was deleted
  ansible.builtin.assert:
    that:
      - delete_uuid_lookup_profile_result.changed
    fail_msg: "UUID lookup profile deletion should report changed"

- name: Delete UUID lookup profile again (idempotency test)
  remnawave.panel.config_profile:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "UUID Lookup Profile"
  register: delete_uuid_lookup_profile_idempotent_result

- name: Assert UUID lookup profile deletion is idempotent
  ansible.builtin.assert:
    that:
      - not delete_uuid_lookup_profile_idempotent_result.changed
    fail_msg: "UUID lookup profile deletion should be idempotent"

- name: Delete test config profile
  remnawave.panel.config_profile:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "E2E Test Profile"
  register: delete_profile_result

- name: Assert config profile was deleted
  ansible.builtin.assert:
    that:
      - delete_profile_result.changed
    fail_msg: "Config profile deletion should report changed"

- name: Delete config profile again (idempotency test)
  remnawave.panel.config_profile:
    api_url: "{{ api_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "E2E Test Profile"
  register: delete_profile_idempotent_result

- name: Assert config profile deletion is idempotent
  ansible.builtin.assert:
    that:
      - not delete_profile_idempotent_result.changed
    fail_msg: "Config profile deletion should be idempotent"
