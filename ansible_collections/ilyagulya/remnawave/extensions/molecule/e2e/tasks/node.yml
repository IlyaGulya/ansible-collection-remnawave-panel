---
# ===========================================
# Section 5: Node Create Tests
# ===========================================

- name: Create a node
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "E2E Test Node"
    address: "10.0.0.1"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: create_node_result

- name: Assert node was created
  ansible.builtin.assert:
    that:
      - create_node_result.changed
      - create_node_result.response is defined
    fail_msg: "Node creation failed"

- name: Create same node again (idempotency test)
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "E2E Test Node"
    address: "10.0.0.1"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: idempotent_node_result

- name: Assert node is idempotent
  ansible.builtin.assert:
    that:
      - not idempotent_node_result.changed
    fail_msg: "Node should be idempotent"

# ===========================================
# Section 6: Node Update Tests
# ===========================================

- name: Update node address
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "E2E Test Node"
    address: "10.0.0.2"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: update_node_result

- name: Assert node was updated
  ansible.builtin.assert:
    that:
      - update_node_result.changed
    fail_msg: "Node update failed"

- name: Update node address again (idempotency test)
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "E2E Test Node"
    address: "10.0.0.2"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: update_node_idempotent_result

- name: Assert node update is idempotent
  ansible.builtin.assert:
    that:
      - not update_node_idempotent_result.changed
    fail_msg: "Node update should be idempotent"

# Store node UUID for later tests
- name: Store node UUID
  ansible.builtin.set_fact:
    node_uuid: "{{ create_node_result.response.uuid }}"

# ===========================================
# Section 7: Node Optional Parameters Tests
# ===========================================

- name: Create node with all optional parameters
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "Full Params Node"
    address: "10.0.0.50"
    port: 8443
    is_traffic_tracking_active: true
    traffic_limit_bytes: 10737418240
    notify_percent: 80
    traffic_reset_day: 15
    country_code: "US"
    consumption_multiplier: 1.5
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: full_params_node_result

- name: Assert full params node was created
  ansible.builtin.assert:
    that:
      - full_params_node_result.changed
      - full_params_node_result.response is defined
      - full_params_node_result.response.port == 8443
      - full_params_node_result.response.is_traffic_tracking_active == true
      - full_params_node_result.response.traffic_limit_bytes == 10737418240
      - full_params_node_result.response.notify_percent == 80
      - full_params_node_result.response.traffic_reset_day == 15
      - full_params_node_result.response.country_code == "US"
      - full_params_node_result.response.consumption_multiplier == 1.5
    fail_msg: "Full params node creation failed or values mismatch"

- name: Create full params node again (idempotency test)
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "Full Params Node"
    address: "10.0.0.50"
    port: 8443
    is_traffic_tracking_active: true
    traffic_limit_bytes: 10737418240
    notify_percent: 80
    traffic_reset_day: 15
    country_code: "US"
    consumption_multiplier: 1.5
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: full_params_idempotent_result

- name: Assert full params node is idempotent
  ansible.builtin.assert:
    that:
      - not full_params_idempotent_result.changed
    fail_msg: "Full params node should be idempotent"

- name: Update traffic settings
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "Full Params Node"
    address: "10.0.0.50"
    port: 8443
    is_traffic_tracking_active: true
    traffic_limit_bytes: 21474836480
    notify_percent: 90
    traffic_reset_day: 15
    country_code: "US"
    consumption_multiplier: 1.5
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: update_traffic_result

- name: Assert traffic settings were updated
  ansible.builtin.assert:
    that:
      - update_traffic_result.changed
      - update_traffic_result.response.traffic_limit_bytes == 21474836480
      - update_traffic_result.response.notify_percent == 90
    fail_msg: "Traffic settings update failed"

# ===========================================
# Section 8: Node Check Mode Tests
# ===========================================

# --- 8.1: Node Create in Check Mode ---
- name: Create node in check mode (new resource)
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "Check Mode Node"
    address: "10.0.0.200"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  check_mode: true
  register: check_mode_create_node_result

- name: Assert check mode reports changed for node create
  ansible.builtin.assert:
    that:
      - check_mode_create_node_result.changed
      - check_mode_create_node_result.diff is defined
      - check_mode_create_node_result.diff.before == {}
      - check_mode_create_node_result.response is defined
      - check_mode_create_node_result.response.name == "Check Mode Node"
      - check_mode_create_node_result.response.address == "10.0.0.200"
    fail_msg: "Check mode should report changed and return response for new node"

- name: Verify check mode did not create node
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "Check Mode Node"
  register: verify_check_mode_no_create_node

- name: Assert check mode node was not created
  ansible.builtin.assert:
    that:
      - not verify_check_mode_no_create_node.changed
    fail_msg: "Check mode should not have created the node"

# --- 8.2: Node Update in Check Mode ---
- name: Update node in check mode
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "E2E Test Node"
    address: "10.0.0.99"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  check_mode: true
  register: check_mode_update_node_result

- name: Assert check mode reports changed for node update
  ansible.builtin.assert:
    that:
      - check_mode_update_node_result.changed
      - check_mode_update_node_result.diff is defined
      - check_mode_update_node_result.diff.before != {}
      - check_mode_update_node_result.diff.after != {}
      - check_mode_update_node_result.response is defined
      - check_mode_update_node_result.response.address == "10.0.0.99"
    fail_msg: "Check mode should report changed and return response for node update"

- name: Delete node in check mode
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: absent
    name: "E2E Test Node"
  check_mode: true
  register: check_mode_delete_node_result

- name: Assert check mode reports changed for node delete
  ansible.builtin.assert:
    that:
      - check_mode_delete_node_result.changed
      - check_mode_delete_node_result.diff is defined
      - check_mode_delete_node_result.diff.after == {}
    fail_msg: "Check mode should report changed for node delete"

- name: Verify node still exists after check mode delete
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    name: "E2E Test Node"
    address: "10.0.0.2"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: verify_node_still_exists

- name: Assert node still exists after check mode delete
  ansible.builtin.assert:
    that:
      - not verify_node_still_exists.changed
    fail_msg: "Node should still exist after check mode delete"

# ===========================================
# Section 9: Node UUID Lookup Tests
# ===========================================

- name: Lookup node by UUID
  ilyagulya.remnawave.node:
    panel_url: "{{ panel_url }}"
    api_token: "{{ api_token }}"
    state: present
    uuid: "{{ node_uuid }}"
    name: "E2E Test Node"
    address: "10.0.0.2"
    port: 443
    config_profile:
      active_config_profile_uuid: "{{ profile_uuid }}"
      active_inbound_uuids:
        - "{{ inbound_uuid }}"
  register: node_uuid_lookup_result

- name: Assert node UUID lookup is idempotent
  ansible.builtin.assert:
    that:
      - not node_uuid_lookup_result.changed
    fail_msg: "Node UUID lookup should be idempotent"
