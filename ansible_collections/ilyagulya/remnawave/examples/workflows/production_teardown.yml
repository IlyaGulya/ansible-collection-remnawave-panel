# AUTOMATICALLY GENERATED - DO NOT EDIT
# Generated by remnawave-ansible-gen
#
# Example: Production-like infrastructure teardown workflow
# Deletes all nodes first (required), then all config profiles
# Demonstrates clean removal of multi-region VPN infrastructure
# Usage: ansible-playbook production_teardown.yml -e @../vars/production_vars.yml
---
- name: Production Infrastructure Teardown
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/production_vars.yml

  tasks:
    # =========================================
    # Step 1: Delete All Nodes
    # Nodes must be deleted before config profiles
    # =========================================

    - name: Delete all nodes
      ilyagulya.remnawave.node:
        api_url: "{{ remnawave_api_url }}"
        api_token: "{{ remnawave_api_token }}"
        state: absent
        name: "{{ item.name }}"
      loop: "{{ nodes }}"
      loop_control:
        label: "{{ item.name }}"
      register: nodes_result

    - name: Display node deletion status
      ansible.builtin.debug:
        msg: "{{ item.item.name }}: {{ 'deleted' if item.changed else 'did not exist' }}"
      loop: "{{ nodes_result.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # =========================================
    # Step 2: Delete All Config Profiles
    # =========================================

    - name: Delete all config profiles
      ilyagulya.remnawave.config_profile:
        api_url: "{{ remnawave_api_url }}"
        api_token: "{{ remnawave_api_token }}"
        state: absent
        name: "{{ item.name }}"
      loop: "{{ config_profiles }}"
      loop_control:
        label: "{{ item.name }}"
      register: profiles_result

    - name: Display profile deletion status
      ansible.builtin.debug:
        msg: "{{ item.item.name }}: {{ 'deleted' if item.changed else 'did not exist' }}"
      loop: "{{ profiles_result.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # =========================================
    # Summary
    # =========================================

    - name: Calculate deletion statistics
      ansible.builtin.set_fact:
        nodes_deleted: "{{ nodes_result.results | selectattr('changed', 'true') | list | length }}"
        profiles_deleted: "{{ profiles_result.results | selectattr('changed', 'true') | list | length }}"

    - name: Display teardown summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Production Infrastructure Teardown Complete"
          - "============================================"
          - ""
          - "Nodes deleted: {{ nodes_deleted }} / {{ nodes | length }}"
          - "Profiles deleted: {{ profiles_deleted }} / {{ config_profiles | length }}"
          - ""
          - "All infrastructure has been removed."
