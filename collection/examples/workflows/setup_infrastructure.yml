# AUTOMATICALLY GENERATED - DO NOT EDIT
# Generated by remnawave-ansible-gen
#
# Example: Complete infrastructure setup workflow
# Creates a config profile and then nodes using that profile
# Usage: ansible-playbook setup_infrastructure.yml -e @../vars/example_vars.yml
---
- name: Setup Remnawave Infrastructure
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/example_vars.yml

  collections:
    - remnawave.panel

  tasks:
    # =========================================
    # Step 1: Create Config Profile
    # =========================================

    - name: Create config profile
      remnawave.panel.config_profile:
        api_url: "{{ remnawave_api_url }}"
        api_token: "{{ remnawave_api_token }}"
        state: present
        name: "{{ config_profile_name }}"
        config: "{{ xray_config }}"
      register: profile_result

    - name: Display config profile result
      ansible.builtin.debug:
        msg: "Created profile '{{ profile_result.response.name }}' with UUID {{ profile_result.response.uuid }}"
      when: profile_result.changed

    # Extract inbound UUID for node configuration
    - name: Set profile and inbound facts
      ansible.builtin.set_fact:
        profile_uuid: "{{ profile_result.response.uuid }}"
        inbound_uuid: "{{ profile_result.response.inbounds[0].uuid }}"

    # =========================================
    # Step 2: Create Nodes
    # =========================================

    - name: Create node
      remnawave.panel.node:
        api_url: "{{ remnawave_api_url }}"
        api_token: "{{ remnawave_api_token }}"
        state: present
        name: "{{ node_name }}"
        address: "{{ node_address }}"
        port: "{{ node_port }}"
        config_profile:
          active_config_profile_uuid: "{{ profile_uuid }}"
          active_inbounds:
            - "{{ inbound_uuid }}"
      register: node_result

    - name: Display node result
      ansible.builtin.debug:
        msg: "Created node '{{ node_result.response.name }}' at {{ node_result.response.address }}"
      when: node_result.changed

    # =========================================
    # Summary
    # =========================================

    - name: Infrastructure setup summary
      ansible.builtin.debug:
        msg:
          - "Infrastructure setup complete!"
          - "Config Profile: {{ config_profile_name }} ({{ profile_uuid }})"
          - "Node: {{ node_name }} at {{ node_address }}:{{ node_port }}"